  10	REM : ********* 6502 MNEMONIC ASSEMBLER, VERSION 2.0 *********
  15	REM : ********* MODIFIED FOR DEC-10 BY DOUG MCNEIL  *********
  20	REM
  30	REM : WRITTEN ORIGINALLY IN HP200F TSS BASIC
  40	REM : CN BE USED WITH ALL 65XX PROCESSORS AS MADE BY COMMODRE,
  50	REM : SYNERTEX, AD ROCKWEL.
  60	REM : ALL MNEMONICS AND DERICTIVES ARE INDUSTRY STANDARD, WITH
  70	REM : THE EXCEPTION OF THE USE OF '.' FOR CURRENT ADDRESS
  80	R=10
  90	T9=0
 100	A=0
 140	L=0
 160	PRINT "SOURCE FILE ";
 170	INPUT T$
 180	PRINT "OBJECT FILE ";
 190	INPUT O$
 200	FILE #1,T$,#2,"SYMTAB.DAT",#3,"TEMP.TMP",#4,O$,#5,"ASCII.TAB"
 250	R8=0
 260	PRINT "PRINTOUT ";
 270	INPUT I$
 280	IF I$ <> "NO" THEN 300
 290	R8=1
 300	PRINT "ASSEMBLY BEGINS..."
 310	C=0
 320	IF END # 1 THEN 2240
 330	L$=""
 340	I$=""
 350	M$=""
 360	O$=""
 370	C$=""
 380	Z$=""
 390	L=L+1
 400	REM : ******* SEPERATE TOKENS, STORE LABEL ASSIGNMENTS *******
 410	READ #1,I$
 420	T5=C
 430	IF I$="" THEN 830
 440	P=1
 450	P$=";"
 460 	GOSUB 3970
 470	IF P1=0 THEN 510
 480	IF P1=1 THEN 800
 490	C$=RIGHT$(I$,LEN(I$)-P1+1)
 500	I$=LEFT$(I$,P1-1)
 510	IF LEFT$(I$,1)="" THEN 590
 520	GOSUB 4940
 530	L$=P$
 540	IF L$ <> "." THEN 590
 550	M$="."
 560	GOSUB 4940
 570	L$=""
 580 	GOTO 860
 590	GOSUB 3790
 600	M$=P$
 605	Q$=LEFT$(M$,1)
 610	IF Q$=".WO" THEN 3110
 620	IF Q$=".TE" THEN 3110
 630	IF Q$=".BY" THEN 3110
 640	IF Q$=".DB" THEN 3110
 650	IF M$ <> "" THEN 850
 660	C$=LEFT$(C$,34)
 670	IF LEN(L$) <> 0 THEN 700
 680	I$=LEFT$(I$,19)
 690	GOTO 820
 700	GOSUB 3790
 710	N$=P$
 720	IF LEN(N$) <> 0 THEN 750
 730	T1=C
 740	GOTO 780
 750	GOSUB 4070
 760	IF T4=2 THEN 830
 770	T1=F1
 780	PRINT #2,L$,T1
 790	CLOSE #2
 800	T9=LEN(I$)
 803	IF T9 < 55 THEN 806
 805	T9=55
 806	I$=LEFT$(I$,T9)
 810	Z$=LEFT$(Z$,17)+I$
 820	T9=LEN(I$)
 823	IF T9+19 > 38 THEN 826
 825	T9=38
 826	IF T9 < 72 THEN  828
 827	T9 = 72
 828	Z$=LEFT$(Z$,T9-1)+C$
 830	PRINT #3,Z$,T5
 840	GOTO 320
 850	IF LEFT$(M$,1) <> "." THEN 1050
 860	P$="="
 870	GOSUB 3970
 880	IF P1 >0 THEN 910
 890	PRINT "MISSING '=' IN LINE ";L
 900 	GOTO 3090
 910	P=P1+1
 920	GOSUB 3790
 930	IF LEFT$(P$,1) <> "" THEN 960
 940	PRINT "MISSING ARGUEMENT IN LINE ";L
 950	GOTO 3090
 960	N$=P$
 970	GOSUB 4070
 980	IF T4 <> 2 THEN 1010
 990	PRINT "ILLEGAL FORWARD REFERENCE IN LINE ";L
1000	GOTO 3090
1010	T1=C
1020 	C=F1
1030	IF L$ <> "" THEN 780
1040	GOTO 800
1050	RESTORE 5710
1060	IF M$="" THEN 1140
1070	FOR I=1 TO 56
1080	READ T$
1090	IF T$=M$ THEN 1130
1100	NEXT  I
1110	PRINT "UNKNOWN OPCODE IN LINE ";L
1120	GOTO 3090
1130	O=I
1140	IF L$="" THEN 1170
1150	PRINT #2,L,C
1160	CLOSE #2
1170	GOSUB 3750
1180	O$=P$
1190	I$=LEFT$(I$,P-LEN(O$)-2)+"!"+RIGHT$(I$,LEN(I$)-(P-LEN(O$)-2))
1200	REM : ******* FIND ADDRESSING MODES, LOAD EFFECTIVE ADDRESS *******
1210	IF O$ <> "" THEN 1240
1220	M=1
1230	GOTO 2200
1240	IF O$ <> "A" THEN 1270
1250	M=2
1260	GOTO 2200
1270	IF LEFT$(O$,1) <> "#" THEN 1320
1280	M=3
1290	P=P+1
1300	N$=RIGHT$(O$,LEN(O$)-1)
1310	GOTO 1870
1320	IF LEFT$(M$,1) <> "B" THEN 1460
1330	IF M$="BIT" THEN 1460
1340	M=12
1350	N$=O$
1360	GOSUB 4070
1370	IF T4 <> 2 THEN 1400
1380	A=-20
1390	GOTO 1970
1400	A=F1-C-2
1410	IF A >= 0 THEN 1430
1420	A=256+A
1430	IF ABS(F1-C) <= 127 THEN 1970
1440	PRINT "BRANCH OUT OF RANGE IN LINE ";L
1450	GOTO 3090
1460	P$="("
1470	P=P-LEN(O$)
1480	GOSUB 3970
1490	P5=P1
1500	P$=","
1510	GOSUB 3970
1520	P6=P1
1530	P7=0
1540	IF P6 <> 0 THEN 1610
1550	IF MID$(I$,P6+1,1)="X" THEN 1580
1560	P7=1
1570	GOTO 1610
1580	IF MID$(I$,P6+1,1)="Y" THEN 1610
1590	PRINT "BAD ADDRESSING MODE IN LINE ";L
1600	GOTO 3090
1610	IF P5 <> 0 THEN 1780
1620	GOSUB 3790
1630	N$=P$
1640	IF P6 <> 0 THEN 1670
1645	IF P7 <> 0 THEN 1670
1650	M=5
1660	GOTO 1710
1670	IF P6 <> 0 THEN 1700
1680	M=6
1690	GOTO 1710
1700	M=4
1710	GOSUB 4070
1720	A=F1
1730	IF T4 <> 2 THEN 1750
1740	A=-1000
1750	IF ABS(A) <= 255 THEN 1970
1760	M=M+3
1770	GOTO 1970
1780	GOSUB 3790
1790	N$=LEFT$(P$,LEN(P$)-1)
1800	IF P6 <> 0 THEN 1830
1805	IF P7 <> 0 THEN 1830
1810	M=10
1820	GOTO 1870
1830	IF P6 <> 0 THEN 1860
1840	M=11
1850	GOTO 1870
1860	M=13
1870	GOSUB 4070
1880	A=F1
1890	IF M <> 10 THEN 1893
1891	GOTO 1895
1893	IF M <> 11 THEN 1920
1895	IF A<=255 THEN 1920
1900	PRINT "VALUE TOO LARGE FOR ZERO PAGE IN LINE ";L
1910	GOTO 3090
1920	IF T4 <> 2 THEN 1970
1930	A=-1000
1940	IF M=13 THEN 1970
1950	A=-200
1960	REM : ******** PRINT OPCPDES & EA ON FILE ********
1970	IF A >= 0 THEN 2070
1980	Z$=LEFT$(Z$,9)+"**"+RIGHT$(Z$,LEN(Z$)-11)
1990	C=C+1
2000	IF M <> 12 THEN 2020
2010	Z$=LEFT$(Z$,10)+"R"+RIGHT$(Z$,LEN(Z$)-11)
2020	W9=A+256
2030	IF W9 >= 0 THEN 2200
2040	Z$=LEFT$(Z$,12)+"**"+RIGHT$(Z$,LEN(Z$)-14)
2050	C =C+1
2060	GOTO 2200
2070	R=16
2080	I=A
2040	GOSUB 4990
2100	T$=A&$
2110	 A$="000"
2120	A$=LEFT$(A$,3)+T$
2130	IF M >= 3 THEN 2134
2131	GOTO 2135
2134	IF M <=6 THEN 2180
2135	IF M >=10 THEN 2138
2136	GOTO 2140
2138	IF M <=12 THEN 2180
2140	Z$=LEFT$(Z$,12)+MID$(A$,LEN(A$)-3,2)+RIGHT$(Z$,LEN(Z$)-14)
2150	Z$=LEFT$(Z$,9)+RIGHT$(A$,2)+RIGHT$(Z$,LEN(Z$)-11)
2160	C=C+2
2170	GOTO 2200
2180	Z$=LEFT$(Z$,9)+RIGHT$(A$,2)+RIGHT$(Z$,LEN(Z$)-11)
2190	C=C+1
2200	R=16
2210	I=T5
2220	GOSUB 4940
2230	T$="000"
2240	T$=LEFT$(T$,3)+A$
2250	Z$=RIGHT$(T$,4)+RIGHT$(Z$,LEN(Z$)-4)
2260	RESTORE 5140
2270	FOR I=1 TO (O-1)*13+M
2280	READ T$
2290	NEXT I
2300	IF T$ <> "  " THEN 2370
2310	IF M > 6 THEN 2350
2315	IF M < 4 THEN 2350
2320	M=M+3
2330	C=T5
2340	GOTO 1970
2350	PRINT "ILLEGAL ADDRESSING MODE IN LINE ";L
2360	GOTO 3090
2370	Z$=LEFT$(Z$,6)+LEFT$(T$,2)+RIGHT$(Z$,LEN(Z$)-8)
2380	Z$=LEFT$(Z$,4)+":"+RIGHT$(Z$,LEN(Z$)-5)
2390	C=C+1
2400	Z$=LEFT$(Z$,16)+I$
2410	T9=LEN(I$)
2405	IF 19+T9 > 38 THEN 2410
2407	T9=38
2410	Z$=LEFT$(Z$,T9-1)+LEFT$(C$,72-T9)
2420	PRINT #3,Z$,T5
2430	GOTO 320
2440 	REM : ******** SECOND PASS* RESOLVE FWD REFERENCES *******
2450	CLOSE 2
2460	CLOSE 3
2470	FILE #1,"SYMTAB.FOO"
2480	L=0
2490	FILE #3,W$
2500	RESTORE #4
2510	IF END #3 THEN 2870
2520	P=1
2530	READ #3,I$,T5
2540	L=L+1
2550	IF I$="" THEN 2850
2560	P$="!"
2570	GOSUB 3970
2580	IF P1=0 THEN 2610
2585	IF P=17 THEN 2610
2590	P=P1
2600	I$=LEFT$(I$,P-1)+" "+RIGHT$(I$,LEN(I$)-P)
2610	IF MID$(I$,10,1) <> "*" THEN 2850
2620	GOSUB 3790
2630	N$=P$
2640	IF LEFT$(N$,1) <> "(" THEN 2660
2650	N$=RIGHT$(N$,LEN(N$)-1)
2660	GOSUB 4070
2670	IF T4 <>  THEN 2700
2680	PRINT "IRRESOLVABLE FWD REF / BAD LABEL IN LINE ";L
2690	GOTO 3090
2700	I=F1
2710	IF MID$(I$,11,1) <> "R" THEN 2750
2720	I=F1-T5-2
2730	IF I >=0 THEN 2750
2740	I=I+256
2750	R=16
2760	GOSUB 4940
2770	T$=A$
2780	A$="000"
2790	A$=LEFT$(A$,3)+T$
2800	IF MID$(I$,13,2) <> "**" THEN 2840
2810	I$=LEFT$(I$,12)+MID$(A$,LEN(A$)-3,3)+RIGHT$(I$,LEN(I$)-14)
2820	I$=LEFT$(I$,9)+RIGHT$(A$,1)+RIGHT$(I$,LEN(I$)-11)
2830	GOTO 2850
2840	I$=LEFT$(I$,9)+RIGHT$(A$,1)+RIGHT$(I$,LEN(I$)-11)
2850	PRINT #4,I$
2860	GOTO 2510
2870	CLOSE #4
2880	IF R8=1 THEN 2080
2890	IF END #4 THEN 2940
2900	RESTORE #4
2910	READ #4,I$
2920	PRINT I$
2930	GOTO 2910
2940	RESTORE #2
2950	PRINT LIN(2);"SYMBOL TABLE:"
2960	IF END #2 THEN 3080
2970	FOR I6=1 TO 3
2980	READ #2,O$,T5
2990	R=16
3000	I=T5
3010	GOSUB 4940
3020	T$="0000"
3030	T$=LEFT$(T$,LEN(T$))+A
3040	PRINT TAB((I6-1)*25+1);O$;TAB((I6-1)*25+13);RIGHT$(T$,3)
